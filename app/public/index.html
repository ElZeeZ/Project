<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Singing Simulator</title>
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- event-set requirements -->
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>

    <!-- Using right thumbstick to move around -->
    <script src="/js/movement.js" type="text/javascript"></script>

    <!-- Superhands & Physics -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.misc.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.1.0/dist/aframe-physics-system.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.3/dist/super-hands.min.js"></script>
    <script src="/js/superhands.js" type="text/javascript"></script>


    <!-- Menu Scripts -->
    <script src="/js/menu_func.js" type="text/javascript"></script>

    <!-- Joystick -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.8.2/nipplejs.min.js"></script>
    <script src="/js/joystick.js" type="text/javascript"></script>
    
  </head>
  <body>
    
    <a-scene>
      <!--Environment-->
      <a-entity environment="preset: starry"></a-entity>
      
      <!--Asset Items-->
      
      <a-assets>
        <a-asset-item id="mixer" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/mixer.glb?v=1731854486178"></a-asset-item>
        <a-asset-item id="djtable" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/djtable.glb?v=1731858049602"></a-asset-item>
        <a-asset-item id="sofa" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/sofa.glb?v=1731867587909"></a-asset-item>
        <a-asset-item id="table" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/table.glb?v=1731870748335"></a-asset-item>
        <a-asset-item id="plant" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/plant.glb?v=1731870753633"></a-asset-item>
        <a-asset-item id="light" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/light.glb?v=1731873770312"></a-asset-item>
        <a-asset-item id="mic" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/mic.glb?v=1731876349981"></a-asset-item>
        <a-asset-item id="water" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/water.glb?v=1731956854003"></a-asset-item>
        <a-asset-item id="stage1" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/stage1.glb?v=1731943044493"></a-asset-item>
        <a-asset-item id="stage2" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/stage2.glb?v=1731949829601"></a-asset-item>
        <a-asset-item id="epiano" src="https://cdn.glitch.me/5c85074e-7ee7-4cb9-938f-07f74bcaf934/epiano.glb?v=1731965491505"></a-asset-item>
        <a-asset-item id="eguitar" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/eguitar.glb?v=1731963257832"></a-asset-item>
        <a-asset-item id="speaker" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/speaker.glb?v=1731964579941"></a-asset-item>
        <a-asset-item id="studiomic" src="https://cdn.glitch.me/5c85074e-7ee7-4cb9-938f-07f74bcaf934/studiomic.glb?v=1731964005267"></a-asset-item>
        
         <audio id="pop" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/pop.mp3?v=1731880990119" autoplaypreload></audio>
         <audio id="doorsound" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/doorsound.mp3?v=1731880650425" autoplaypreload></audio>
         <audio id="lofi" src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/lofi.mp3?v=1731952977093" autoplay loop></audio>
        
        <img
          id="wall"
          src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/istockphoto-1629900571-612x612.jpg?v=1731872942899"
        />
        <img
          id="cdoor"
          src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/thumbnails_TexturesCom_WoodOldRough3_512_albedo.jpg?v=1731872722009"
        />
        <img
          id="knob"
          src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/TexturesCom_Metal_Corroded_512_roughness.jpg?v=1731872434222"
        />
        <img
          id="wood"
          src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/TexturesCom_Wood_RusticVeneer_512_albedo.jpg?v=1731872058212"
        />
        <img
          id="wood-nm"
          src="https://cdn.glitch.global/5c85074e-7ee7-4cb9-938f-07f74bcaf934/TexturesCom_Wood_RusticVeneer_512_normal.jpg?v=1731872057497"
        />
        
      </a-assets>
      
    
     <a-entity position="0 0 0">
      <!--Objects-->
      <a-entity gltf-model="#mixer" position="-3 -1 -10" scale="0.03 0.03 0.03" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#djtable" position="0 0.25 -4.5" scale="0.002 0.002 0.002" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#sofa" position="-0.7 -0.12 1.5" rotation="0 180 0" scale="0.015 0.012 0.012" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#table" position="-0.8 -0.05 2.2" scale="0.2 0.2 0.2" rotation="0 270 0" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#plant" position="-2.7 0 -4" scale="1.4 1.4 1.4" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#water" position="3.6 0 -4.5" scale="0.01 0.01 0.01" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#stage1" position="-100 10 0" scale="0.04 0.04 0.04" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#stage2" position="-100 10 0" scale="0.04 0.04 0.04" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#epiano" position="-0.8 -0.05 2" scale="0.04 0.04 0.04" shadow="cast:true; receive:true"></a-entity>
      <a-entity gltf-model="#studiomic" position="-0.8 -0.05 2" scale="0.04 0.04 0.04" shadow="cast:true; receive:true"></a-entity>  
      <a-entity gltf-model="#eguitar" position="-0.8 -0.05 2" scale="0.04 0.04 0.04" shadow="cast:true; receive:true"></a-entity> 
      <a-entity gltf-model="#speaker" position="-0.8 -0.05 2" scale="0.04 0.04 0.04" shadow="cast:true; receive:true"></a-entity> 
       <!--Mic Object-->
       <a-entity 
  id="mic-entity"
  position="1.8 1 -4" 
  rotation="-110 50 -70" 
  scale="0.2 0.2 0.2" 
  shadow="cast:true; receive:true"
  animation__hover="property: position; dir: alternate; dur: 2000; loop: true; easing: easeInOutSine; to: 1.8 1.2 -4">

  <!-- Microphone Model -->
  <a-entity gltf-model="#mic"></a-entity>
  
  <!-- Main Mic Test Text -->
  <a-entity 
    id="mic-text"
    text="align: center; baseline: bottom; color: #FFFFFF; font: exo2semibold; value: Mic Test; width: 9; side: double" 
    position="0 0 0" 
    rotation="80 60 50">
  </a-entity>
  
  <!-- Detection Text -->
  <a-entity 
    id="mic-detection-text"
    text="value: ; color: green; width: 3; align: center"
    position="0 1 0"
    visible="false">
  </a-entity>
</a-entity>
      
      
      <!--Walls-->
      <a-box position="4 1.25 -1" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="8" width="0.25" height="2.5" shadow="cast:true; receive:true"></a-box>
      
      <a-box static-body class="collidable" position="-3.5 1.25 1.75" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="2.5" width="0.25" height="2.5" shadow="cast:true; receive:true"></a-box>
      <a-box static-body class="collidable" position="-3.5 1.25 -4.25" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="1.5" width="0.25" height="2.5" shadow="cast:true; receive:true"></a-box>
      <a-box static-body class="collidable" position="-3.5 2.1875 -1.5" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="4" width="0.25" height="0.625" shadow="cast:true; receive:true"></a-box>
      
      <a-box static-body class="collidable" position="-7.25 1.25 -3.75" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="0.25" width="7.25" height="2.5" shadow="cast:true; receive:true"></a-box>
      <a-box static-body class="collidable" position="-7.25 1.25 0.75" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="0.25" width="7.25" height="2.5" shadow="cast:true; receive:true"></a-box>
      
      <a-box static-body class="collidable" position="0.25 1.25 -4.875" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="0.25" width="7.25" height="2.5" shadow="cast:true; receive:true"></a-box>
      
      <a-box static-body class="collidable" position="-0.6 1.25 3.125" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="0.25" width="6" height="2.5" shadow="cast:true; receive:true"></a-box>
      <a-box static-body class="collidable" position="3.75 1.25 3.125" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="0.25" width="0.75" height="2.5" shadow="cast:true; receive:true"></a-box>
      <a-box static-body class="collidable" position="2.75 2.125 3.125" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="0.25" width="2" height="0.75" shadow="cast:true; receive:true"></a-box>
      
       <!--Ceilings-->
      <a-box position="0.25 2.625 -1" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="22" width="22" height="0.25" shadow="cast:true; receive:true"></a-box>
      
      <!--Floor-->
      <a-plane position="0 0.1 0" material="color: white; src: #wood;repeat: 2 2;normal-map: #wood-nm;normal-texture-repeat: 2 2;normal-scale: 1 -1; roughness: 0.5 " rotation="-90 0 0" width="30" height="30" shadow="cast:true; receive:true"></a-plane>
      
      <!--Door-->
      <a-entity id="door" position="2.375 0.875 3.025"  rotation="0 0 0" height="1.75" width="2" depth="0.4">
        <a-box  material="color: white; src: #cdoor;repeat: 2 2; roughness: 0.5 " height="1.75" width="1" depth="0.1" position="0.5 0 0" shadow="cast:true; receive:true">
          <a-sphere position="0.375 0 0.07" material="color: white; src: #knob;repeat: 2 2; roughness: 0.5 " radius="0.03" shadow="cast:true; receive:true"></a-sphere>
          <a-sphere position="0.375 0 -0.07" material="color: white; src: #knob;repeat: 2 2; roughness: 0.5 " radius="0.03" shadow="cast:true; receive:true"></a-sphere>
          <a-cylinder position="0.375 0 0" material="color: white; src: #knob;repeat: 2 2; roughness: 0.5 " rotation="90 0 0" radius="0.01" height="0.125" src="#metal" shadow="cast:true; receive:true"></a-cylinder>
          <a-cylinder position="-0.5 0.65101 -0.025" material="color: white; src: #knob;repeat: 2 2; roughness: 0.5 " radius="0.02" height="0.1" shadow="cast:true; receive:true"></a-cylinder>
        <a-cylinder position="-0.5 -0.65101 -0.025" material="color: white; src: #knob;repeat: 2 2; roughness: 0.5 " radius="0.02" height="0.1" shadow="cast:true; receive:true"></a-cylinder>
        </a-box>
      </a-entity>
       
       <!--Stage Door-->
       
       <a-entity static-body id="stage-door" scale="2.2 1.3 1.5" position="-10 0 -1.5" rotation="0 90 0">
  <a-entity text="; align: center; baseline: bottom; color: #FFFFFF; font: exo2semibold; value: To Stage; width: 9; side: double" position="0 1.5 0.1" scale="0.6 1 1"></a-entity>

  <!-- Left Door -->
  <a-box id="left-door" 
         position="-0.5 1 0" 
         width="1" 
         height="2" 
         depth="0.1" 
         color="#8B4513" 
         shadow="cast:true; receive:true">
    <!-- Left Door Knob -->
    <a-sphere 
       position="0.35 -0.2 0.06" 
       scale="0.8 1 1"
       radius="0.05" 
       color="#D4AF37" 
       shadow="cast:true; receive:true">
    </a-sphere>
  </a-box>

  <!-- Right Door -->
  <a-box id="right-door" 
         position="0.5 1 0" 
         width="1" 
         height="2" 
         depth="0.1" 
         color="#8B4513" 
         shadow="cast:true; receive:true">
    <!-- Right Door Knob -->
    <a-sphere 
       position="-0.35 -0.2 0.06"
       scale="0.8 1 1"
       radius="0.05" 
       color="#D4AF37" 
       shadow="cast:true; receive:true">
    </a-sphere>
  </a-box>
</a-entity>
       
       
       
      
      <!--Light-->
      <a-entity gltf-model="#light" position="0 2.2 -1" scale="0.5 0.5 0.5" shadow="cast:true; receive:true">
        <a-entity position="0 -0.6 0" light="color: #e3d787; intensity: 1.2; type: point; castShadow:true"></a-entity>   
      </a-entity>
      
      <!--Text-->
      <a-entity text="align: center; baseline: bottom; color: #FFFFFF; font: exo2semibold; value: Welcome to Stage Simulator; width: 9; side: double" position="0 2 -4.7" ></a-entity>
      
      
     <!-- Camera & Hands -->
<!-- Rig is where the camera and the controllers are built in.
     To change the camera position/attributes change the rig's -->
<a-entity
  id="rig"
  wasd-controls
  look-controls
  position="0 -0.3 0"
  networked="template:#rig-template"
  spawn-in-circle="radius:2"
>
  <a-entity
    id="player"
    mixin="physics-hands"
    camera
    position="0 1.6 0"
    networked="template:#head-template"
    visible="true"
  >
    <!-- Cursor -->
    <a-entity
      id="cursor"
      cursor="fuse: true; fuseTimeout: 1500"
      position="0 0 -0.03" 
      geometry="primitive: ring; radiusInner: 0.0005; radiusOuter: 0.001"
      material="color: black; shader: flat"
    ></a-entity>
  </a-entity>

  <!-- Right hand controller -->
  <a-entity
    class="controller"
    id="rhand"
    mixin="physics-hands"
    networked-hand-controls="hand: right"
    raycaster="objects: .hittable; far: 0.4"
    line="color: #000000"
    oculus-thumbstick-controls
    texture-painter
  ></a-entity>

  <!-- Left hand controller -->
  <a-entity
    class="controller"
    id="lhand"
    mixin="physics-hands"
    networked-hand-controls="hand: left"
    raycaster="objects: .hittable; far: 0.4"
    line="color: #000000"
    oculus-thumbstick-controls
    menu-visibility
    texture-painter
  >
    <!-- Menu pane -->
    <a-plane
      id="menu"
      position="0 0.15 0.05"
      rotation="-90 0 0"
      width="0.5"
      height="0.1"
      color="#cccccc"
      material="opacity:1; shader: flat"
      visible="false"
    >
      <a-text
        id="arrow_left"
        value="<"
        position="-0.24 0.01 0"
        color="#373737"
        scale="0.5 0.9 1"
      ></a-text>
      <a-text
        id="arrow_right"
        value=">"
        position="0.16 0.01 0"
        color="#373737"
        scale="0.5 0.9 1"
      ></a-text>
      <a-entity id="asset_background">
        <a-plane
          position="0 0 0.001"
          width="0.07"
          height="0.07"
          material="opacity:0.3; shader: flat"
          color="#E0DF4B"
        ></a-plane>
        <a-plane
          position="0.12 0 0.001"
          width="0.07"
          height="0.07"
          color="#373737"
        ></a-plane>
        <a-plane
          position="-0.12 0 0.001"
          width="0.07"
          height="0.07"
          color="#373737"
        ></a-plane>
      </a-entity>

      <a-entity id="assets_menu"> </a-entity>
    </a-plane>
  </a-entity>
</a-entity>

      
      <!--Tuning room-->
      <a-box static-body position="4 1.25 5" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="8" width="0.25" height="2.5" shadow="cast:true; receive:true"></a-box>
      <a-box static-body position="-6 1.25 8.75" rotation ="0 90 0" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="20" width="0.25" height="2.5" shadow="cast:true; receive:true"></a-box>
      <a-box static-body position="-10 1.25 4.75" material="color: white; src: #wall ;repeat: 2 2; roughness: 0.5 " depth="8" width="0.25" height="2.5" shadow="cast:true; receive:true"></a-box>
   
       
       <!-- Mixins are for superhands control -->
        <!-- All-interactions for assets to be scaled/moved
            Physics hands for the controllers on oculus devices-->
        <a-mixin
          id="all-interactions"
          dynamic-body
          hoverable
          grabbable
          stretchable
          draggable
          droppable
          event-set__hoveron="_event: hover-start; material.opacity: 0.5; transparent: true"
          event-set__hoveroff="_event: hover-end; material.opacity: 1; transparent: false"
        ></a-mixin>

        <a-mixin
          id="physics-hands"
          physics-collider
          phase-shift
          collision-filter="collisionForces: false"
          static-body="shape: sphere; sphereRadius: 0.02"
          super-hands="colliderEvent: collisions;
                       colliderEventProperty: els;
                       colliderEndEvent: collisions;
                       colliderEndEventProperty: clearedEls;"
        ></a-mixin>



       
       
      </a-entity>
  </a-scene>
    
    
     <!--Door Function-->
     <script>
      let doorOpen = false; // Track the door's state (open or closed)

      document.addEventListener('DOMContentLoaded', () => {
        const door = document.querySelector('#door');
        const doorsound = document.querySelector('#doorsound'); // Select the audio element

        door.addEventListener('click', () => {
          doorsound.play(); // Play the "doorsound" sound on click
          
          const newRotation = doorOpen ? '0 0 0' : '0 90 0'; // Toggle between open and closed rotations
          door.setAttribute('animation', {
            property: 'rotation',
            to: newRotation,
            dur: 1000,
            easing: 'easeInOutQuad'
          });
          doorOpen = !doorOpen; // Toggle the door state
        });
      });
    </script>

    <!--Mic Function-->
    <script>
  document.addEventListener('DOMContentLoaded', () => {
    const micEntity = document.querySelector('#mic-entity');
    const micText = document.querySelector('#mic-text');
    const micDetectionText = document.querySelector('#mic-detection-text');
    const popSound = document.querySelector('#pop'); // Select the audio element

    let isMicTesting = false; // To track if the mic is currently being tested
    let stream = null; // To hold the microphone stream

    // Function to reset text
    function resetText() {
      micText.setAttribute('text', 'value: Mic Test'); // Reset the main text to "Mic Test"
      micDetectionText.setAttribute('visible', false); // Hide detection text
    }

    // Function to stop microphone testing and reset the state
    function stopTesting() {
      if (stream) {
        stream.getTracks().forEach((track) => track.stop()); // Stop the microphone stream
        stream = null; // Clear the stream
      }
      isMicTesting = false; // Reset the testing state
      resetText(); // Reset the text to "Mic Test"
    }

    // Function to start microphone testing
    async function testMicrophone() {
      try {
        if (!stream) {
          // Request access to the microphone
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        }

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);

        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        function checkSound() {
          analyser.getByteTimeDomainData(dataArray);
          const isSoundDetected = dataArray.some((value) => value > 128 + 10 || value < 128 - 10); // Simple sound threshold
          if (isSoundDetected) {
            micText.setAttribute('text', 'value: Mic Detected'); // Update the main text
            micDetectionText.setAttribute('text', 'value: Microphone Detected'); // Display detection message
            micDetectionText.setAttribute('visible', true); // Make detection text visible
          } else {
            micText.setAttribute('text', 'value: Mic Not Detected'); // Update the main text
            micDetectionText.setAttribute('text', 'value: Microphone Not Detected'); // Display error message
            micDetectionText.setAttribute('visible', true); // Make detection text visible
          }
          if (isMicTesting) {
            requestAnimationFrame(checkSound); // Continue checking if testing is still active
          }
        }
        checkSound();
      } catch (error) {
        console.error('Microphone access denied or not available:', error);
        stopTesting(); // Ensure everything resets if access fails
        micText.setAttribute('text', 'value: Mic Access Denied'); // Display access denied message
        micDetectionText.setAttribute('text', 'value: Microphone not available');
        micDetectionText.setAttribute('visible', true);
      }
    }

    // Click event listener for the microphone
    micEntity.addEventListener('click', async () => {
      popSound.play(); // Play the "pop" sound on click

      if (isMicTesting) {
        micText.setAttribute('text', 'value: Mic Test');
        stopTesting(); // Stop testing and reset text
      } else {
        isMicTesting = true; // Start testing
        micText.setAttribute('text', 'value: Testing Mic...'); // Update text to testing
        micDetectionText.setAttribute('text', 'value: Testing Microphone...');
        micDetectionText.setAttribute('visible', true); // Show testing text
        testMicrophone(); // Start testing
      }
    });

    // Hover effects: enlarge on hover
    micEntity.addEventListener('mouseenter', () => {
      micEntity.setAttribute('scale', '0.25 0.25 0.25'); // Enlarge on hover
    });

    micEntity.addEventListener('mouseleave', () => {
      micEntity.setAttribute('scale', '0.2 0.2 0.2'); // Reset to original size
    });
  });
</script>
  
  <!--TP To Stage-->
   <script>
  document.addEventListener('DOMContentLoaded', () => {
    const stageDoor = document.querySelector('#stage-door');
    const player = document.querySelector('#player').parentNode; // Select the player entity

    stageDoor.addEventListener('click', () => {
      player.setAttribute('position', { x: -100, y: 12.5, z: 36 });  // Teleport player
      console.log('Player teleported to stage!');
    });
  });
</script>
  
  </body>
</html>
